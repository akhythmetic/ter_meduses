import matplotlib.pyplot as plt
from skimage.feature import hog
from skimage import exposure
import cv2
import numpy as np
import os

#Dossier contenant les frames
frames_folder = "Chemin du dossier"


image_files = [f for f in os.listdir(frames_folder) if f.endswith(('.jpg', '.png'))] #Sert à récupèrer la liste des fichiers images en gardant seulement ceux avec l'extension .jpg et .png
image_files.sort()  # pour garder l'ordre des frames

#Cette boucle sert à parcourir toutes les images du fichier image_files, puis les charger avec OpenCV
for img_file in image_files:
    img_path = os.path.join(frames_folder, img_file)
    image_bgr = cv2.imread(img_path)

    if image_bgr is None:
        print(f"Impossible de lire {img_path}") #Ici permet de voir si l'image existe et si c'est possible de la lire
        continue

    # Convertir en niveaux de gris
    image_gray = cv2.cvtColor(image_bgr, cv2.COLOR_BGR2GRAY)

    features, hog_image = hog(
        image_gray,
        orientations=9,
        pixels_per_cell=(8, 8),
        cells_per_block=(2, 2),
        visualize=True,
        block_norm="L2-Hys"
    )

    print(f"Traitement de {img_file} terminé. Taille du vecteur HOG : {features.shape[0]}")

    # Affiche uniquement la première image pour savoir si cela a fonctionné
    if img_file == image_files[0]:
        fig, (ax1, ax2) = plt.subplots(1, 2, figsize=(12, 6), sharex=True, sharey=True)
        ax1.imshow(image_gray, cmap=plt.cm.gray)
        ax1.set_title(f"Image originale : {img_file}")

        #Amélioration du contraste pour visualiser les HOGs
        hog_image_rescaled = exposure.rescale_intensity(hog_image, in_range=(0, 10))
        ax2.imshow(hog_image_rescaled, cmap=plt.cm.gray)
        ax2.set_title("HOG")
        plt.show()

    #Calcul et Affiche pour chaque image, les informations importantes des hogs. Avec la dimension de l'image, le nombre de cellule, etc
    height, width = image_gray.shape
    cell_size = (8, 8)
    cells_x = width // cell_size[1]
    cells_y = height // cell_size[0]
    block_size = (2, 2)
    blocks_x = cells_x - block_size[1] + 1
    blocks_y = cells_y - block_size[0] + 1
    hog_per_cell = features.reshape(blocks_y, blocks_x, block_size[0], block_size[1], 9)
    mean_hist = np.mean(hog_per_cell)

    print(f"Dimensions de l'image : {width} x {height}")
    print(f"Nombre de cellules : {cells_x} x {cells_y} = {cells_x*cells_y} cellules")
    print(f"Nombre de blocs : {blocks_x} x {blocks_y} = {blocks_x*blocks_y} blocs")
    print(f"Valeur moyenne des histogrammes HOG : {mean_hist:.4f}\n")
